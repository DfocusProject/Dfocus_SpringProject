<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>홈</title>
    <link rel="stylesheet" href="/css/common.css"/>
    <link rel="stylesheet" href="/css/home.css"/>
</head>
<body>
<div th:replace="~{ header.html::header}"></div>

<main>
    <div th:replace="~{ sidebar.html::sidebar}"></div>

    <div class="container">
        <div id="error-message" th:text="${error}" style="display:none;"></div>

        <!--        <div class="header-content">-->
        <!--            <div class="header-left">-->
        <!--                <h1 th:text="${userName} + ' 님'">시원 님</h1>-->
        <!--                <p th:text="${today}">2024년 11월 26일 수요일</p>-->
        <!--            </div>-->
        <!--            <div class="header-right">-->
        <!--                <div class="current-time" id="currentTime">09:23:45</div>-->
        <!--            </div>-->
        <!--        </div>-->

        <!-- 대시보드 -->
        <div class="dashboard-grid">

            <!-- 출퇴근 관리 -->
            <div class="card attendance-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">출퇴근 관리</div>
                        <div class="card-subtitle">Attendance</div>
                    </div>
                </div>


                <div class="time-display">
                    <div class="status-item">
                        <div class="status-label">근무시간</div>
                        <div class="status-value" th:text="${workHours != null} ? ${workHours} : '--:--'">--:--</div>
                    </div>
                </div>
                <div class="attendance-status">
                    <div class="status-item">
                        <div class="status-label">출근시간</div>
                        <span th:text="${commuteDto != null and commuteDto.workOnTime != null} ? ${commuteDto.workOnTime} : '출근 정보 없음'"></span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-label">퇴근시간</div>
                    <span th:text="${commuteDto != null and commuteDto.workOffTime != null} ? ${commuteDto.workOffTime} : '퇴근 정보 없음'"></span>
                </div>

                <!-- 출퇴근 기록 -->
                <div class="attendance-buttons">
                    <form th:action="@{/commute/on}" method="post" style="display:inline;">
                        <button class="btn btn-primary" type="submit">출근</button>
                    </form>
                    <form th:action="@{/commute/off}" method="post" style="display:inline;">
                        <button class="btn btn-success" type="submit">퇴근</button>
                    </form>
                </div>
            </div>

<!--            이번주 근무 현황-->
            <div class="card weekly-work-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">이번주 근무 현황</div>
                        <div class="card-subtitle">Weekly Work Hours</div>
                    </div>
                </div>

                <div class="bar-chart">
                    <!-- JS가 여기 안에 bar-item 추가 -->
                </div>
            </div>

            <!-- 연차 현황 카드 -->
            <div class="card annual-leave-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">연차 현황</div>
                        <div class="card-subtitle">Annual Leave Status</div>
                    </div>
                </div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span>사용률</span>
                        <span><strong
                                th:text="${annualLeave != null} ? ${annualLeave.usageRate} : '40'">40</strong>%</span>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill"
                             th:style="'width: ' + ${annualLeave != null ? annualLeave.usageRate : 40} + '%'"
                             style="width: 40%"></div>
                    </div>
                </div>

                <div class="leave-stats">
                    <div class="leave-stat">
                        <div class="leave-stat-value" th:text="${annualLeave != null} ? ${annualLeave.total} : '15'">
                            15
                        </div>
                        <div class="leave-stat-label">총 연차</div>
                    </div>

                    <div class="leave-stat">
                        <div class="leave-stat-value" th:text="${annualLeaveDto.useDay != null} ? ${annualLeaveDto.useDay} : '6'">6
                        </div>
                        <div class="leave-stat-label">사용</div>
                    </div>

                    <div class="leave-stat">
                        <div class="leave-stat-value" th:text="${annualLeaveDto.balanceDay != null} ? ${annualLeaveDto.balanceDay} : '9'">
                            9
                        </div>
                        <div class="leave-stat-label">잔여</div>
                    </div>

                    <div class="leave-stat">
                        <div class="leave-stat-value" th:text="${annualLeaveDto.expectedDay != null} ? ${annualLeaveDto.expectedDay} : '2'">
                            2
                        </div>
                        <div class="leave-stat-label">예정</div>
                    </div>
                </div>
            </div>

            <!-- 오늘의 할일 -->
            <div class="card task-card">
                <div class="card-header">
                    <div>
                        <div class="card-title">오늘의 알림</div>
                        <div class="card-subtitle">Today's Tasks</div>
                    </div>
                </div>

                <div class="task-stats">
                    <div class="task-stat">
                        <div class="task-stat-circle total">
                            <span th:text="${taskStats != null} ? ${taskStats.total} : '9'">9</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value"
                                  th:text="${taskStats != null} ? ${taskStats.total} : '9'">9</span>
                            <span class="task-stat-label">전체 업무</span>
                        </div>
                    </div>

                    <div class="task-stat">
                        <div class="task-stat-circle completed">
                            <span th:text="${taskStats != null} ? ${taskStats.completed} : '4'">4</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value" th:text="${taskStats != null} ? ${taskStats.completed} : '4'">4</span>
                            <span class="task-stat-label">완료</span>
                        </div>
                    </div>

                    <div class="task-stat">
                        <div class="task-stat-circle pending">
                            <span th:text="${taskStats != null} ? ${taskStats.pending} : '5'">5</span>
                        </div>
                        <div class="task-stat-info">
                            <span class="task-stat-value"
                                  th:text="${taskStats != null} ? ${taskStats.pending} : '5'">5</span>
                            <span class="task-stat-label">진행중</span>
                        </div>
                    </div>
                </div>

                <div class="task-list">
                    <div class="task-item"
                         th:each="task : ${tasks}"
                         th:classappend="'priority-' + ${task.priority}">
                        <div class="task-checkbox" onclick="toggleTask(this)"></div>

                        <div class="task-content">
                            <div class="task-title" th:text="${task.title}">API 문서 작성</div>
                            <div class="task-meta">
                                <span class="task-time">⏰ <span th:text="${task.dueTime}">14:00</span></span>
                                <span th:text="${task.category}">개발</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div> <!-- task-card end -->

        </div> <!-- dashboard-grid end -->

    </div> <!-- container end -->

</main>

<script>
    const error = document.getElementById("error-message").innerText;
    if (error) {
        alert(error);
    }
</script>

<script th:src="@{/js/script.js}"></script>
<script th:src="@{/js/home.js}"></script>
<script th:inline="javascript">
    /* 서버에서 weeklyWorkedHours를 넘겨줍니다 */
    const weeklyWorkedHours = /*[[${weeklyWorkedHours}]]*/ [8.5, 9.0, 8.0, 0, 0, 0, 0];

    const weekdays = ['월','화','수','목','금','토','일'];

    /* JS 기준 오늘 인덱스 (0=월) */
    const today = new Date();
    const todayIndex = today.getDay() === 0 ? 6 : today.getDay() - 1;

    const chartContainer = document.querySelector('.bar-chart');

    weeklyWorkedHours.forEach((hour, i) => {
        // bar-item
        const barItem = document.createElement('div');
        barItem.className = 'bar-item';

        // bar
        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = (hour * 15) + 'px';
        bar.dataset.day = weekdays[i];
        bar.dataset.hours = hour;

        const barValue = document.createElement('span');
        barValue.className = 'bar-value';
        barValue.textContent = hour + 'h';
        bar.appendChild(barValue);

        // label
        const barLabel = document.createElement('div');
        barLabel.className = 'bar-label';
        barLabel.textContent = weekdays[i];
        if (i === todayIndex) barLabel.classList.add('today');

        // bar-item에 붙이기
        barItem.appendChild(bar);
        barItem.appendChild(barLabel);

        // chartContainer에 붙이기
        chartContainer.appendChild(barItem);
    });
</script>
</body>
</html>
