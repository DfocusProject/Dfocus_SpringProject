<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì¼ë°˜ê·¼íƒœ ì‹ ì²­</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/att.css" />
</head>

<body>
<div th:replace="~{header.html::header}"></div>

<main>
    <div th:replace="~{sidebar.html::sidebar}"></div>
    <div class="container">
        <div class="header">
            <h1>ì¼ë°˜ ê·¼íƒœ ì‹ ì²­</h1>
        </div>

        <!-- ğŸ” ê²€ìƒ‰ í¼ -->
        <form id="searchForm" class="search-box" action="/att/search" method="get">
            <label>ê·¼ë¬´ìœ í˜•
                <select name="attType">
                    <option value="ì—°ì¥" th:selected="${attType == 'ì—°ì¥'}">ì—°ì¥ê·¼ë¡œ</option>
                    <option value="ì¡°ì¶œ" th:selected="${attType == 'ì¡°ì¶œ'}">ì—°ì¥(ì¡°ì¶œ)ê·¼ë¡œ</option>
                    <option value="íœ´ì¼" th:selected="${attType == 'íœ´ì¼'}">íœ´ì¼ê·¼ë¡œ</option>
                    <option value="ì¡°í‡´" th:selected="${attType == 'ì¡°í‡´'}">ì¡°í‡´</option>
                    <option value="ì™¸ì¶œ" th:selected="${attType == 'ì™¸ì¶œ'}">ì™¸ì¶œ</option>
                    <option value="ë°˜ì°¨" th:selected="${attType == 'ë°˜ì°¨'}">ë°˜ì°¨</option>
                </select>
            </label>

            <label>ê·¼ë¬´ì¼
                <input type="date" name="workDate" id="workDate"
                       th:value="${workDate != null} ? ${workDate} : ${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
            </label>

            <label for="empCode">ì‚¬ë²ˆ</label>
            <input type="text" id="empCode" name="empCode"
                   th:value="${role == 'USER'} ? ${empCode} : ''"
                   th:readonly="${role == 'USER'}"
                   placeholder="ì‚¬ë²ˆ ì…ë ¥" />


            <label for="deptName">ë¶€ì„œ</label>
            <input type="text" id="deptName" name="deptName" th:value="${deptName}" readonly placeholder="ë¶€ì„œëª…" />

            <button type="submit" id="btnSearch">ì¡°íšŒ</button>

            <span class="note">â€» ê·¼ë¬´ì¼ ì„ íƒ í›„ 'ì¡°íšŒ' í´ë¦­</span>
        </form>

        <!-- ë²„íŠ¼ ì˜ì—­ -->
        <div class="btn-area">
            <button class="btn btn-save" id="btnSave">ì €ì¥</button>
            <button class="btn btn-delete" id="btnDelete">ì‚­ì œ</button>
            <button class="btn btn-request" id="btnRequest">ìƒì‹ </button>
            <button class="btn btn-cancel" id="btnRequestCancel">ìƒì‹  ì·¨ì†Œ</button>
        </div>

        <!-- ê·¼íƒœ í…Œì´ë¸” -->
        <table id="attTable">
            <thead>
            <tr>
                <th><input type="checkbox" id="checkAll"></th>
                <th>ì‚¬ë²ˆ</th>
                <th>ì„±ëª…</th>
                <th>ì§ìœ„</th>
                <th>ë¶€ì„œ</th>
                <th>ê³„íš</th>
                <th>ì‹¤ì </th>
                <th>êµ¬ë¶„</th>
                <th>ì‚¬ìœ </th>
                <th>ì‚¬ìœ ë‚´ìš©</th>
                <th>ì‹œì‘ì‹œê°„</th>
                <th>ì¢…ë£Œì‹œê°„</th>
                <th class="highlight">ì˜ˆìƒê·¼ë¡œì‹œê°„</th>
                <th>ìƒíƒœ</th>
                <th>ì‹ ì²­ì</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <tr th:each="emp : ${empList}">
                <td><input type="checkbox" class="rowCheck" th:value="${emp.empNo}"></td>
                <td class="empNo" th:text="${emp.empNo}"></td>
                <td class="name" th:text="${emp.name}"></td>
                <td class="position" th:text="${emp.position}"></td>
                <td class="department" th:text="${emp.department}"></td>
                <td class="plan" th:text="${emp.plan}"></td>
                <td class="result" th:text="${emp.realWorkRecord}"></td>
                <td class="workType" th:text="${emp.workType}"></td>

                <td>
                    <select class="reason">
                        <option value="">--ì„ íƒ--</option>
                        <option value="ì—…ë¬´ì§€ì—°" th:selected="${emp.reqReason == 'ì—…ë¬´ì§€ì—°'}">ì—…ë¬´ì§€ì—°</option>
                        <option value="í”„ë¡œì íŠ¸ë§ˆê°" th:selected="${emp.reqReason == 'í”„ë¡œì íŠ¸ë§ˆê°'}">í”„ë¡œì íŠ¸ ë§ˆê°</option>
                        <option value="ê³ ê°ìš”ì²­" th:selected="${emp.reqReason == 'ê³ ê°ìš”ì²­'}">ê³ ê° ìš”ì²­</option>
                        <option value="ê¸°íƒ€" th:selected="${emp.reqReason == 'ê¸°íƒ€'}">ê¸°íƒ€</option>
                    </select>
                </td>

                <!-- ì‚¬ìœ ìƒì„¸ - ì €ì¥ëœ ê°’ í‘œì‹œ -->
                <td><input type="text" class="reasonDetail" th:value="${emp.reqReasonDetail}"></td>

                <!-- ì¶œí‡´ê·¼ ì‹œê°„ ìë™ ì…ë ¥ -->
                <td><input type="time" class="startTime" th:value="${emp.startTime}"></td>
                <td><input type="time" class="endTime" th:value="${emp.endTime}"></td>

                <td class="expectedHours highlight"></td>
                <td class="status" th:switch="${emp.reqStatus}">
                    <span th:case="'SAVED'">ì €ì¥</span>
                    <span th:case="'SUBMITTED'">ìƒì‹ </span>
                    <span th:case="'APPROVED'">ìŠ¹ì¸</span>
                    <span th:case="'REJECTED'">ë°˜ë ¤</span>
                    <span th:case="*"></span>
                </td>
                <td class="applicant" th:text="${emp.applicant}"></td>
            </tr>
            <tr th:if="${#lists.isEmpty(empList)}">
                <td colspan="15" style="text-align:center;">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            </tbody>
        </table>
    </div>
</main>
<script th:inline="javascript">
    /*<![CDATA[*/
    const errorMsg = /*[[${error}]]*/ null;
    if (errorMsg != null) {
        alert(errorMsg);
    }
    /*]]>*/
</script>

<script>
    // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì…ë ¥
    const dateInput = document.getElementById("workDate");
    // const today = new Date();
    // dateInput.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

    // ì „ì²´ ì²´í¬
    document.getElementById('checkAll').addEventListener('change', e => {
        const checked = e.target.checked;
        document.querySelectorAll('.rowCheck').forEach(cb => cb.checked = checked);
    });

    // ì„ íƒëœ í–‰ ë°ì´í„° ìˆ˜ì§‘
    function collectSelectedRows() {
        return Array.from(document.querySelectorAll('.rowCheck:checked')).map((cb, index) => {
            const row = cb.closest('tr');
            return {
                empNo: row.querySelector('.empNo').innerText,
                //name: row.querySelector('.name').innerText,
                //position: row.querySelector('.position').innerText,
                //department: row.querySelector('.department').innerText,
                workType: row.querySelector('.workType').innerText,
                reason: row.querySelector('.reason').value,
                reasonDetail: row.querySelector('.reasonDetail').value,
                startTime: row.querySelector('.startTime').value,
                endTime: row.querySelector('.endTime').value,

                //expectedHours: row.querySelector('.expectedHours').innerText || '',
                //status: row.querySelector('.status').innerText || '',
                //applicant: row.querySelector('.applicant').innerText || ''
            };
        });
    }

    // í¼ ì œì¶œ ë° ë°ì´í„° ì „ì†¡
    function submitForm() {
        const rows = collectSelectedRows();
        if (rows.length === 0) {
            alert('ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        // ìˆ¨ê²¨ì§„ form ìƒì„±
        const hiddenForm = document.createElement('form');
        hiddenForm.method = 'POST';
        hiddenForm.action = '/att/save';  // ì €ì¥ URL

        // workDate ì¶”ê°€
        const workDateInput = document.createElement('input');
        workDateInput.type = 'hidden';
        workDateInput.name = 'workDate';
        workDateInput.value = dateInput.value;
        hiddenForm.appendChild(workDateInput);

        // attList ì¶”ê°€ (ê° ì‚¬ì›ë³„ ê·¼íƒœ ì •ë³´)
        rows.forEach((row, index) => {
            Object.entries(row).forEach(([key, value]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `attList[${index}].${key}`;
                input.value = value;
                hiddenForm.appendChild(input);
            });
        });

        // í¼ì„ DOMì— ì¶”ê°€í•˜ê³  ì œì¶œ
        document.body.appendChild(hiddenForm);
        hiddenForm.submit();
    }

    // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
    document.getElementById('btnSave').addEventListener('click', submitForm);
</script>
<script th:src="@{/js/script.js}"></script>
</body>

</html>