<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>부서 상세 정보</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/dept.css" />
</head>
<body>
<div th:replace="~{ header.html::header}"></div>
<main>
    <div th:replace="~{ sidebar.html::sidebar}"></div>
    <div class="container">
        <div class="dept-detail-container">
            <!-- 왼쪽: 부서 상세 -->
            <div class="dept-info">
                <h2 th:utext="${dept.deptName} + '<br/>부서 상세 정보'">부서 상세 정보</h2>

                <div class="info-item">
                    <label>부서 코드</label>
                    <span th:text="${dept.deptCode}">D001</span>
                </div>

                <div class="info-item">
                    <label>상위 부서</label>
                    <span th:text="${dept.parentDept}">경영본부</span>
                </div>

                <div class="info-item">
                    <label>현재 리더</label>
                    <span th:text="${dept.deptLeader}">홍길동</span>
                </div>

                <div class="info-item">
                    <label>카테고리</label>
                    <span th:text="${dept.deptCategory}">팀</span>
                </div>

                <div class="info-item">
                    <label>부서 시작일</label>
                    <span th:text="${dept.startDate}">2023-01-01</span>
                </div>

                <div class="info-item">
                    <label>사용 여부</label>
                    <span th:text="${dept.useYn == 'Y' ? '사용 중' : '미사용'}"
                          th:classappend="${dept.useYn == 'Y' ? 'used' : 'not-used'}">
                        사용 중
                    </span>
                </div>

                <div class="info-item">
                    <label>근태 패턴 코드</label>

                    <!-- 현재 패턴 표시 -->
                    <span th:if="${dept.workPattern != null}" th:text="${dept.workPattern}">A1001</span>

                    <!-- 버튼: 패턴 없으면 '지정하기', 있으면 '변경하기' -->
                    <button type="button" id="setPatternBtn"
                            th:text="${dept.workPattern != null ? '변경하기' : '패턴 지정하기'}">
                        패턴 지정하기
                    </button>

                    <!-- 드롭다운 & 저장 (숨김) -->
                    <div id="patternSelect" style="display:none; margin-top:5px;">
                        <form th:action="@{/dept/patternSave}" method="post" id="patternForm">
                            <input type="hidden" name="deptCode" th:value="${dept.deptCode}" />
                            <select name="patternCode" required>
                                <option th:each="p : ${patternList}" th:value="${p}" th:text="${p}"
                                        th:selected="${p == dept.workPattern}">패턴명</option>
                            </select>
                            <button type="submit">저장</button>
                        </form>
                    </div>

                </div>

            </div>
            <!-- 기존 부서 구성원 테이블 상단에 배치 -->
            <div id="personalPatternSelect" style="display:none; margin-top:10px;">
                <form th:action="@{/dept/setPersonalPattern}" method="post" id="personalPatternForm">
                    <!-- 체크된 사원 목록을 hidden input으로 생성 -->
                    <div id="personalEmpInputs"></div>

                    <!-- 개별 패턴용 드롭다운 (별도로 생성) -->
                    <label for="personalPatternCode">개별 패턴 선택:</label>
                    <select name="patternCode" id="personalPatternCode" required>
                        <option th:each="p : ${patternList}" th:value="${p}" th:text="${p}">패턴명</option>
                    </select>
                    <button type="submit">저장</button>
                </form>
            </div>

            <!-- 오른쪽: 구성원 목록 -->
            <div class="dept-side">
                <form th:action="@{/dept/empAction}" method="post">
                    <input type="hidden" name="deptCode" th:value="${dept.deptCode}" />

                    <!-- 상단 섹션: 부서 구성원 -->
                    <div class="member-section">
                        <h3>부서 구성원</h3>

                        <div class="emp-actions">
                            <button type="submit" name="action" value="delete">부서에서 삭제</button>
                            <button type="submit" name="action" value="setLeader">리더로 지정</button>
                            <button type="button" id="moveDeptBtn">다른 부서로 이동</button>
                            <button type="button" id="setPersonalPattern">개별 근태패턴 지정</button>
                        </div>

                        <!-- 부서 이동 선택 영역 (숨김) -->
                        <div id="moveDeptSelect" style="display: none; margin-bottom: 10px;">
                            <label for="newDept">이동할 부서 선택:</label>
                            <select name="newDeptCode" id="newDept" required>
                                <option th:each="d : ${allDepts}" th:value="${d.deptCode}" th:text="${d.deptName}">부서명</option>
                            </select>
                            <button type="submit" name="action" value="moveDept">이동 실행</button>
                        </div>

                        <!-- 스크롤 영역 -->
                        <div class="table-scroll">
                            <table class="emp-table">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>사원 번호</th>
                                    <th>사원 이름</th>
                                    <th>직위</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="emp : ${emps}">
                                    <td><input type="checkbox" name="empCodes" th:value="${emp.empCode}"/></td>
                                    <td th:text="${emp.empCode}">E001</td>
                                    <td th:text="${emp.empName}">홍길동</td>
                                    <td th:text="${emp.positionName}">P1001</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 하단 섹션: 부서 미배정 사원 -->
                    <div class="no-dept-section">
                        <h3>부서 미배정 사원</h3>

                        <div class="emp-actions">
                            <button type="submit" name="action" value="assignDept">이 부서로 배정</button>
                        </div>

                        <!-- 스크롤 영역 -->
                        <div class="table-scroll">
                            <table class="emp-table">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>사원 번호</th>
                                    <th>사원 이름</th>
                                    <th>직위</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="emp : ${empsNoDept}">
                                    <td><input type="checkbox" name="empCodes" th:value="${emp.empCode}"/></td>
                                    <td th:text="${emp.empCode}">E999</td>
                                    <td th:text="${emp.empName}">김무소속</td>
                                    <td th:text="${emp.positionName}">P0000</td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(empsNoDept)}">
                                    <td colspan="4" style="text-align:center;">모든 사원이 부서에 배정되어 있습니다.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>
<script th:inline="javascript">
    /*<![CDATA[*/
    const errorMsg = /*[[${message}]]*/ null;
    if (errorMsg != null) {
        alert(errorMsg);
    }
    /*]]>*/
</script>
<script>
    const moveBtn = document.getElementById('moveDeptBtn');
    const moveSelect = document.getElementById('moveDeptSelect');

    moveBtn.addEventListener('click', () => {
        moveSelect.style.display = moveSelect.style.display === 'none' ? 'block' : 'none';
    });
</script>
<script>
    const setPatternBtn = document.getElementById('setPatternBtn');
    const patternSelect = document.getElementById('patternSelect');

    if (setPatternBtn) {
        setPatternBtn.addEventListener('click', () => {
            patternSelect.style.display = patternSelect.style.display === 'none' ? 'block' : 'none';
        });
    }
</script>
<script>
    const personalBtn = document.getElementById('setPersonalPattern');
    const personalSelect = document.getElementById('personalPatternSelect');
    const personalEmpInputs = document.getElementById('personalEmpInputs');

    personalBtn.addEventListener('click', () => {
        // 체크된 사원들 가져오기
        const checkedEmps = Array.from(document.querySelectorAll('input[name="empCodes"]:checked'))
            .map(cb => cb.value);

        if (checkedEmps.length === 0) {
            alert("먼저 사원을 선택해주세요.");
            return;
        }

        // 기존 hidden input 초기화
        personalEmpInputs.innerHTML = '';

        // 체크된 사원마다 hidden input 생성 (서버에서 List<String>으로 바인딩)
        checkedEmps.forEach(empCode => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'empCodes';
            input.value = empCode;
            personalEmpInputs.appendChild(input);
        });

        // 우측 드롭다운 영역 표시
        personalSelect.style.display = 'block';
    });

</script>
<script th:src="@{/js/script.js}"></script>
</body>
</html>