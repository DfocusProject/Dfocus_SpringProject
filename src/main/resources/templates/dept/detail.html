<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>부서 상세 정보</title>
    <link rel="stylesheet" href="/css/common.css"/>
    <link rel="stylesheet" href="/css/dept.css"/>
</head>
<body>
<div th:replace="~{ header.html::header}"></div>
<main>
    <div th:replace="~{ sidebar.html::sidebar}"></div>
    <div class="container">
        <div class="dept-detail-container">
            <div class="spacer"></div> <!-- 좌측 공백 -->
            <!-- 왼쪽: 부서 상세 -->
            <div class="dept-info">
                <h2 th:utext="${dept.deptName} + '<br/>부서 상세 정보'">부서 상세 정보</h2>

                <div class="info-item">
                    <label>부서 코드</label>
                    <span th:text="${dept.deptCode}">D001</span>
                </div>

                <div class="info-item">
                    <label>상위 부서</label>
                    <span th:text="${dept.parentDept}">경영본부</span>
                </div>

                <div class="info-item">
                    <label>현재 리더</label>
                    <span th:text="${dept.deptLeader}">홍길동</span>
                </div>

                <div class="info-item">
                    <label>카테고리</label>
                    <span th:text="${dept.deptCategory}">팀</span>
                </div>

                <div class="info-item">
                    <label>부서 시작일</label>
                    <span th:text="${dept.startDate}">2023-01-01</span>
                </div>

                <div class="info-item">
                    <label>사용 여부</label>
                    <span th:text="${dept.useYn == 'Y' ? '사용 중' : '미사용'}"
                          th:classappend="${dept.useYn == 'Y' ? 'used' : 'not-used'}">
                        사용 중
                    </span>
                </div>

                <div class="info-item">
                    <label>근태 패턴 코드</label>

                    <!-- 현재 패턴 표시 -->
                    <span th:if="${dept.workPattern != null}" th:text="${dept.workPattern}">A1001</span>
                    <!-- 드롭다운 & 저장 (숨김 처리) -->
                    <div id="patternSelect" style="display:none; margin-top:5px;">
                        <form th:action="@{/dept/patternSave}" method="post" id="patternForm">
                            <input type="hidden" name="deptCode" th:value="${dept.deptCode}"/>
                            <select name="patternCode" required>
                                <option th:each="p : ${patternList}" th:value="${p}" th:text="${p}"
                                        th:selected="${p == dept.workPattern}">패턴명
                                </option>
                            </select>
                            <button type="submit">저장</button>
                        </form>
                    </div>
                    <!-- 버튼: 패턴 없으면 '지정하기', 있으면 '변경하기' -->
                    <button type="button" id="setPatternBtn"
                            th:text="${dept.workPattern != null ? '변경하기' : '패턴 지정하기'}">
                        패턴 지정하기
                    </button>

                </div>

            </div>
            <!-- 오른쪽: 구성원 목록 -->
            <div class="dept-members"> <!-- 부서 구성원 영역 -->
                <div class="dept-side">
                    <form th:action="@{/dept/empAction}" method="post">
                        <input type="hidden" name="deptCode" th:value="${dept.deptCode}"/>

                        <!-- 상단 섹션: 부서 구성원 -->
                        <div class="member-section">
                            <h3>부서 구성원</h3>

                            <div class="emp-actions">
                                <button type="submit" name="action" value="delete">부서에서 삭제</button>
                                <button type="submit" name="action" value="setLeader">리더로 지정</button>
                                <button type="button" id="moveDeptBtn">다른 부서로 이동</button>
                                <button type="button" id="setPersonalPattern">개별 근태패턴 지정</button>
                                <button type="button" id="changeLeave">휴직 변경</button>
                            </div>

                            <!-- 개인 근태패턴 지정 (숨김) -->
                            <div id="personalPatternSelect" style="display:none;">
                                <div id="personalEmpInputs"></div> <!-- 선택된 사원 input 필드들 -->
                                <div class="personal-pattern-container">
                                    <label for="personalPatternCode">개별 패턴 선택:</label>
                                    <select name="patternCode" id="personalPatternCode" required>
                                        <option th:each="p : ${patternList}" th:value="${p}" th:text="${p}">패턴명</option>
                                    </select>
                                    <button id="person-pattern-submit" type="submit" name="action"
                                            value="setPersonalPattern">저장
                                    </button>
                                </div>
                            </div>

                            <!-- 부서 이동 선택 영역 (숨김) -->
                            <div id="moveDeptSelect" style="display: none;" >
                                <label for="newDept">이동할 부서 선택:</label>
                                <select name="newDeptCode" id="newDept" required>
                                    <option th:each="d : ${allDepts}" th:value="${d.deptCode}" th:text="${d.deptName}">
                                        부서명
                                    </option>
                                </select>
                                <button type="submit" name="action" value="moveDept">이동 실행</button>
                            </div>

                            <!-- 휴직 변경 영역 (숨김) -->
                            <div id="leaveChangeSelect" style="display:none;">
                                <div id="leaveEmpInputs"></div> <!-- 선택된 사원 input 필드들 -->
                                <label for="leaveType">휴직 상태 선택:</label>
                                <select name="leaveType" id="leaveType" required>
                                    <option value="WK">재직</option> <!--working -->
                                    <option value="BL">휴직</option>
                                    <option value="PL">육아휴직</option>
                                </select>
                                <button id="leave-change-submit" type="submit" name="action" value="changeLeave">저장
                                </button>
                            </div>

                            <!-- 스크롤 영역 -->
                            <div class="table-scroll">
                                <table class="emp-table">
                                    <thead>
                                    <tr>
                                        <th></th>
                                        <th>사원 번호</th>
                                        <th>사원 이름</th>
                                        <th>직위</th>
                                        <th>상태</th>
                                        <th>근태패턴</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="emp : ${emps}">
                                        <td><input type="checkbox" name="empCodes" th:value="${emp.empCode}"/></td>
                                        <td th:text="${emp.empCode}">E001</td>
                                        <td th:text="${emp.empName}">홍길동</td>
                                        <td th:text="${emp.positionName}">P1001</td>
                                        <td th:text="${emp.status == 'OFF' ? '휴직' : '재직'}">상태</td>
                                        <td th:text="${emp.workPatternCode}">육아휴직</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 하단 섹션: 부서 미배정 사원 -->
                        <div class="no-dept-section">
                            <div class="section1">
                                <h3>부서 미배정 사원</h3>

                                <div class="emp-actions">
                                    <button type="submit" name="action" value="assignDept">이 부서로 배정</button>
                                </div>
                            </div>
                            <!-- 스크롤 영역 -->
                            <div class="table-scroll">
                                <table class="emp-table">
                                    <thead>
                                    <tr>
                                        <th></th>
                                        <th>사원 번호</th>
                                        <th>사원 이름</th>
                                        <th>직위</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="emp : ${empsNoDept}">
                                        <td><input type="checkbox" name="empCodes" th:value="${emp.empCode}"/></td>
                                        <td th:text="${emp.empCode}">E999</td>
                                        <td th:text="${emp.empName}">김무소속</td>
                                        <td th:text="${emp.positionName}">P0000</td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(empsNoDept)}">
                                        <td colspan="4" style="text-align:center;">모든 사원이 부서에 배정되어 있습니다.</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="spacer"></div> <!-- 우측 공백 -->
        </div>
    </div>
</main>
<script th:inline="javascript">
    /*<![CDATA[*/
    const errorMsg = /*[[${message}]]*/ null;
    if (errorMsg != null) {
        alert(errorMsg);
    }
    /*]]>*/
</script>
<script th:src="@{/js/dept-detail.js}"></script>
<script th:src="@{/js/script.js}"></script>
</body>
</html>
