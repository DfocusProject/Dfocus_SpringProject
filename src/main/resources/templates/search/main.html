<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>부서근태 조회</title>
    <link rel="stylesheet" href="/css/att.css" />
</head>

<body>

<h2>부서근태 조회</h2>

<!-- 검색 폼 -->
<form th:action="@{/attendance/list}" method="get" style="display:flex; gap:10px; align-items:center;">
    <label>근무일
        <input type="date" name="date" th:value="${workDate}">
    </label>
    <label>사번
        <input type="text" name="empCode"
               th:value="${#authorization.expression('hasRole(''LEADER'')') ? '' : #authentication.name}"
               th:readonly="${!#authorization.expression('hasRole(''LEADER'')')}"
               placeholder="사번 입력" />
    </label>
    <label>근무계획
        <select name="plan" id="planType">
            <option value="" th:selected="${planType == ''}">전체</option>
            <option value="05" th:selected="${planType == '05'}">주간</option>
            <option value="05-A" th:selected="${planType == '05-A'}">현장실습</option>
            <option value="06" th:selected="${planType == '06'}">연차</option>
            <option value="10" th:selected="${planType == '10'}">출장</option>
            <option value="31" th:selected="${planType == '31'}">4전</option>
            <option value="32" th:selected="${planType == '32'}">4후</option>
            <option value="33" th:selected="${planType == '33'}">4야</option>
            <option value="45" th:selected="${planType == '45'}">3전</option>
            <option value="46" th:selected="${planType == '46'}">3후</option>
            <option value="61" th:selected="${planType == '61'}">휴직</option>
            <option value="64" th:selected="${planType == '64'}">육아휴직</option>
            <option value="62" th:selected="${planType == '62'}">사외교육</option>
        </select>
    </label>
    <label>부서
        <input type="text" name="deptName" th:value="${#authentication.principal.deptName}" readonly placeholder="부서명" />
    </label>
    <button type="submit">조회</button>
</form>

<!-- 근태 신청 (POST) -->
<form id="attForm" method="post">
    <input type="hidden" name="empCodes" id="empCodes">
    <button type="button" id="btnGoGeneral">일반근태 신청</button>
    <button type="button" id="btnGoEtc">기타근태 신청</button>

    <table>
        <thead>
        <tr>
            <th rowspan="2"><input type="checkbox" id="checkAll1"></th>
            <th rowspan="2">사번</th>
            <th rowspan="2">성명</th>
            <th rowspan="2">직위</th>
            <th rowspan="2">부서</th>
            <th rowspan="2">계획/실적</th>
            <th rowspan="2">가근태</th>
            <th rowspan="2">출근시간(지정단말)</th>
            <th rowspan="2">퇴근시간(지정단말)</th>
            <th rowspan="2">휴일근무</th>
            <th rowspan="2">연장근무</th>
            <th colspan="3" id="weekRange">${weekRange}</th>
        </tr>
        <tr>
            <th class="highlight">주근무시간</th>
            <th>예상근무시간</th>
            <th>예상잔여시간</th>
        </tr>
        </thead>

        <tbody id="tbody">
        <tr th:each="row : ${attList}">
            <td><input type="checkbox" class="rowCheck" th:attr="data-empCode=${row.empCode}"> </td>
            <td th:text="${row.empCode}"></td>
            <td th:text="${row.empName}"></td>
            <td th:text="${row.position}"></td>
            <td th:text="${row.deptName}"></td>
            <td th:text="${row.planType}"></td>
            <td th:text="${row.attStatus}"></td>
            <td th:text="${row.startTime}"></td>
            <td th:text="${row.endTime}"></td>
            <td th:text="${row.holidayWork}"></td>
            <td th:text="${row.overtimeWork}"></td>
            <td th:text="${row.regularTime}"></td>
            <td th:text="${row.expectedTime}"></td>
            <td th:text="${row.remainTime}"></td>
        </tr>
        </tbody>
    </table>
</form>

<script>
    // 전체 선택/해제
    const checkAll = document.getElementById("checkAll1");
    checkAll.addEventListener("change", function() {
        const rowChecks = document.querySelectorAll("input.rowCheck");
        rowChecks.forEach(cb => cb.checked = checkAll.checked);
    });

    const rowChecks = document.querySelectorAll("input.rowCheck");
    rowChecks.forEach(cb => cb.addEventListener("change", function() {
        const allChecked = Array.from(rowChecks).every(c => c.checked);
        checkAll.checked = allChecked;
    }));

    // 선택된 사번 가져오기
    function getSelectedEmpCodes() {
        const checked = document.querySelectorAll("input.rowCheck:checked");
        if (!checked.length) return null;
        return Array.from(checked).map(cb => cb.getAttribute("data-empCode")).join(",");
    }

    // 일반근태 신청
    document.getElementById("btnGoGeneral").addEventListener("click", function() {
        const empCodes = getSelectedEmpCodes();
        if (!empCodes) {
            alert("근태신청할 부서원을 선택하십시오.");
            return;
        }
        const form = document.getElementById("attendanceForm");
        form.action = "/attendance/generalApply"; // POST 처리 URL
        document.getElementById("empCodes").value = empCodes;
        form.submit();
    });

    // 기타근태 신청
    document.getElementById("btnGoEtc").addEventListener("click", function() {
        const empCodes = getSelectedEmpCodes();
        if (!empCodes) {
            alert("근태신청할 부서원을 선택하십시오.");
            return;
        }
        const form = document.getElementById("attendanceForm");
        form.action = "/attendance/etcApply"; // POST 처리 URL
        document.getElementById("empCodes").value = empCodes;
        form.submit();
    });
</script>

</body>
</html>
