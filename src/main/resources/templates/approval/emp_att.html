<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>부서원 일근태 승인</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
    <link rel="stylesheet" th:href="@{/css/emp_att.css}">
</head>

<body>
<div th:replace="~{header.html::header}"></div>
<main>
    <div th:replace="~{sidebar.html::sidebar}"></div>
    <div class="container">
        <div class="header">
            <h1>부서원 일근태 승인</h1>
        </div>
        <div class="att-layout">

            <!-- 왼쪽 영역 -->
            <div class="left">

                <!-- 검색 영역 -->
                <div class="search-box">
                    <form th:action="@{/emp-att/approval/search}" th:object="${search}" method="get">

                    <div class="search-row">
                            <label>대상일자
                                <input type="date" name="startDate" th:value="${search.startDate}" required>
                                <span>~</span>
                                <input type="date" name="endDate" th:value="${search.endDate}" required>
                            </label>

                            <label>사번
                                <input type="text" th:field="*{empCode}" placeholder="사번 입력"/>
                            </label>

                            <button type="submit" class="btnSearchEmpAtt">조회</button>
                        </div>

                        <div class="search-row">
                            <label>근태유형
                                <select th:field="*{reqType}">
                                    <option value="">근태유형 전체</option>
                                    <option th:each="type : ${reqTypes}" th:value="${type}" th:text="${type}"></option>
                                </select>
                            </label>

                            <label>신청근태
                                <select th:field="*{reqDetailType}">
                                    <option value="">신청근태 전체</option>
                                    <option th:each="detail : ${reqDetailTypes}" th:value="${detail}"
                                            th:text="${detail}"></option>
                                </select>
                            </label>

                            <label>부서</label>
                            <input type="text" th:field="*{department}" th:value="${#authentication.principal.deptName}"
                                   readonly placeholder="부서명"/>
                        </div>
                    </form>
                </div>

                <!-- 탭 -->
                <div class="list-tabs">
                    <div class="tab-header">
                        <div class="tab-buttons">
                            <button class="tab-btn active" data-tab="tab1">결재할 문서</button>
                            <button class="tab-btn" data-tab="tab2">승인된 문서</button>
                            <button class="tab-btn" data-tab="tab3">반려된 문서</button>
                        </div>
                        <div class="bulk-buttons">
                            <button class="btn bulk-approval">일괄승인</button>
                            <button class="btn bulk-rejection">일괄반려</button>
                        </div>
                    </div>

                    <div class="tab-contents">
                        <!-- TAB1: 결재할 문서 -->
                        <div class="list tab-content active" id="tab1">
                            <table>
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkAll1"></th>
                                    <th>결재번호</th>
                                    <th>신청사번</th>
                                    <th>상신자</th>
                                    <th>대상자부서</th>
                                    <th>신청근태</th>
                                    <th>대상자</th>
                                    <th>대상일</th>
                                </tr>
                                </thead>
                                <tbody th:each="doc : ${pendingDocsList}">
                                <tr>
                                    <td>
                                        <input type="checkbox" class="rowCheck">
                                        <input type="hidden" class="requestId" th:value="${doc.requestId}">
                                    </td>
                                    <td th:text="${doc.requestId}"></td>
                                    <td th:text="${doc.empCode}"></td>
                                    <td th:text="${doc.reqEmpName}"></td>
                                    <td th:text="${doc.department}"></td>
                                    <td th:text="${doc.reqDetailType}"></td>
                                    <td th:text="${doc.resEmpName}"></td>
                                    <td th:text="${doc.reqDate}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- TAB2: 승인된 문서 -->
                        <div class="list tab-content" id="tab2">
                            <table>
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkAll2"></th>
                                    <th>결재번호</th>
                                    <th>신청사번</th>
                                    <th>상신자</th>
                                    <th>대상자부서</th>
                                    <th>신청근태</th>
                                    <th>대상자</th>
                                    <th>대상일</th>
                                </tr>
                                </thead>
                                <tbody th:each="doc : ${approvedDocsList}">
                                <tr>
                                    <td>
                                        <input type="checkbox" class="rowCheck">
                                        <input type="hidden" class="requestId" th:value="${doc.requestId}">
                                    </td>
                                    <td th:text="${doc.requestId}"></td>
                                    <td th:text="${doc.empCode}"></td>
                                    <td th:text="${doc.reqEmpName}"></td>
                                    <td th:text="${doc.department}"></td>
                                    <td th:text="${doc.reqDetailType}"></td>
                                    <td th:text="${doc.resEmpName}"></td>
                                    <td th:text="${doc.reqDate}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- TAB3: 반려된 문서 -->
                        <div class="list tab-content" id="tab3">
                            <table>
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="checkAll3"></th>
                                    <th>결재번호</th>
                                    <th>신청사번</th>
                                    <th>상신자</th>
                                    <th>대상자부서</th>
                                    <th>신청근태</th>
                                    <th>대상자</th>
                                    <th>대상일</th>
                                </tr>
                                </thead>
                                <tbody th:each="doc : ${rejectedDocsList}">
                                <tr>
                                    <td>
                                        <input type="checkbox" class="rowCheck">
                                        <input type="hidden" class="requestId" th:value="${doc.requestId}">
                                    </td>
                                    <td th:text="${doc.requestId}"></td>
                                    <td th:text="${doc.empCode}"></td>
                                    <td th:text="${doc.reqEmpName}"></td>
                                    <td th:text="${doc.department}"></td>
                                    <td th:text="${doc.reqDetailType}"></td>
                                    <td th:text="${doc.resEmpName}"></td>
                                    <td th:text="${doc.reqDate}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <div class="footer"></div>
            </div> <!-- left -->

            <!-- 오른쪽 상세 영역 -->
            <div class="right">
                <div class="panel">
                    <div class="pan-header">
                        일근태 신청 상세 <span>신청번호: <input type="hidden" name="requestId" id="detailRequestId"></span>
                    </div>

                    <div class="body">
                        <!-- 기본 정보 -->
                        <table class="detail-table">
                            <tbody>
                            <tr>
                                <th>신청자</th>
                                <td th:text="${empInfo.reqEmpCode + ' / ' + empInfo.reqEmpName}"></td>
                                <th>부서명</th>
                                <td th:text="${reqInfo.department}"></td>
                                <th>신청일</th>
                                <td th:text="${empInfo.reqDate}"></td>
                            </tr>
                            <tr>
                                <th>대상자</th>
                                <td th:text="${reqInfo.empCode + ' / ' + reqInfo.empName}"></td>
                                <th>부서명</th>
                                <td th:text="${reqInfo.department}"></td>
                                <th>계획근무</th>
                                <td th:text="${empInfo.planType}"></td>
                            </tr>
                            </tbody>
                        </table>

                        <!-- 근태기 정보 -->
                        <div class="panel">
                            <div class="title">근태기 정보</div>
                            <div class="body">
                                <table class="detail-table">
                                    <thead>
                                    <tr>
                                        <th>날짜</th>
                                        <th>출근시간</th>
                                        <th>퇴근시간</th>
                                    </tr>
                                    </thead>
                                    <tbody th:each="info : ${attMachineInfo}">
                                    <tr>
                                        <td th:text="${info.date}"></td>
                                        <td th:text="${info.startTime}"></td>
                                        <td th:text="${info.endTime}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 결재 정보 -->
                        <div class="panel">
                            <div class="title">결재 정보</div>
                            <div class="body">
                                <div class="reason-action">
                                    <div class="rejection-reason">
                                        <label class="label">반려사유</label>
                                        <input type="text" placeholder="결재의견을 입력하십시오.">
                                    </div>
                                    <div class="actions">
                                        <button type="submit" name="status" value="APPROVED" class="btn approval">승인
                                        </button>
                                        <button type="submit" name="status" value="REJECTED" class="btn rejection">반려
                                        </button>
                                    </div>
                                </div>

                                <table class="detail-table">
                                    <thead>
                                    <tr>
                                        <th>순번</th>
                                        <th>구분</th>
                                        <th>부서</th>
                                        <th>직책</th>
                                        <th>이름</th>
                                        <th>사번</th>
                                        <th>결과</th>
                                        <th>결재완료일</th>
                                    </tr>
                                    </thead>
                                    <tbody th:each="apv : ${approvalInfo}">
                                    <tr>
                                        <td th:text="${apv.sequenceNo}"></td>
                                        <td th:text="${apv.type}"></td>
                                        <td th:text="${apv.department}"></td>
                                        <td th:text="${apv.duty}"></td>
                                        <td th:text="${apv.name}"></td>
                                        <td th:text="${apv.empCode}"></td>
                                        <td th:text="${apv.result == 'PENDING' ? '대기' : (apv.result == 'APPROVED' ? '승인' : '반려')}"></td>
                                        <td th:text="${apv.date != null ? apv.date : ''}"></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div> <!-- right -->

        </div> <!-- att-layout -->
    </div>
</main>

<script th:src="@{/js/script.js}"></script>
<script>
    // 탭 처리
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const target = btn.dataset.tab;
            tabContents.forEach(tc => {
                tc.id === target ? tc.classList.add('active') : tc.classList.remove('active');
            });
        });
    });

    // 체크박스 전체선택
    ['checkAll1', 'checkAll2', 'checkAll3'].forEach(id => {
        const master = document.getElementById(id);
        master && master.addEventListener('change', () => {
            document.querySelectorAll(`#${id.replace('checkAll', 'tab')} .rowCheck`).forEach(chk => chk.checked = master.checked);
        });
    });

    // 일괄 승인/반려
    const bulkAction = (status) => {
        const selectedIds = Array.from(document.querySelectorAll('#tab1 .rowCheck:checked'))
            .map(chk => chk.nextElementSibling.value);
        if (selectedIds.length === 0) {
            alert('선택된 문서가 없습니다.');
            return;
        }
        fetch('/emp-att/approval/bulk', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({requestIds: selectedIds, status})
        }).then(() => location.reload());
    };
    document.querySelector('.bulk-approval').addEventListener('click', () => bulkAction('APPROVED'));
    document.querySelector('.bulk-rejection').addEventListener('click', () => bulkAction('REJECTED'));
</script>
</body>
</html>
