<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê·¼íƒœíŒ¨í„´ë³„ ìº˜ë¦°ë”</title>
    <link rel="stylesheet" href="/css/common.css" />
    <link rel="stylesheet" href="/css/pattern.css" />
</head>
<body>
<div th:replace="~{ header.html::header}"></div>

<main>
    <div th:replace="~{ sidebar.html::sidebar}"></div>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h2>ğŸ¢ ê·¼íƒœíŒ¨í„´ë³„ ìº˜ë¦°ë”</h2>
                <!-- ìƒë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
                <div class="button-group">
                    <button type="button" class="btn">ì´ˆê¸° ìƒì„±</button>
                    <button type="button" id="topActionBtn" class="btn">íŒ¨í„´ ì¶”ê°€</button>
                    <button type="button" id="registerPatternBtn" class="btn">íŒ¨í„´ ë“±ë¡</button>
                    <button type="button" id="savePatternBtn" class="btn">ì €ì¥</button>
                </div>
            </div>
            <form th:action="@{/pattern/main}" method="get" id="searchForm">
                <label>ì¡°íšŒì›”:</label>
                <input type="month" name="yearMonth" th:value="${selectedYearMonth}">
                <label>íŒ¨í„´ëª…:</label>
                <input name="pattern">
                <button type="submit">ğŸ” ì¡°íšŒ</button>
            </form>
        </div>
        <div class="main-content">
            <form th:action="@{/pattern/save}" method="post" class="calendar-form" id="patternSaveForm">
                <input type="hidden" name="patternName" id="savePatternName">
                <div class="calendar-container">
                    <table id="patternTable">
                        <thead>
                        <tr>
                            <th class="pattern-header"></th>
                            <th class="pattern-header">ê·¼íƒœíŒ¨í„´</th>
                            <th th:each="date : ${dates}" class="date-header"
                                th:classappend="${date.dayOfWeek.value >= 6} ? 'weekend' : ''"
                                th:data-full-date="${date}">
                                <div class="date-header-date" th:text="${#numbers.formatInteger(date.dayOfMonth,2)} + 'ì¼'">01ì¼</div>
                                <div class="date-header-day"
                                     th:text="'(' + ${date.dayOfWeek.toString().substring(0,3)} + ')'">(MON)</div>
                            </th>
                        </tr>
                        </thead>
                        <tbody id="patternBody">
                        <tr th:each="pattern, stat : ${patternList}" th:data-pattern-name="${pattern.patternName}">
                            <td><input type="radio" name="selectedPattern" th:value="${pattern.patternName}"></td>
                            <td th:text="${pattern.patternName}">íŒ¨í„´ëª…</td>
                            <td th:each="date : ${dates}"
                                class="code-cell"
                                th:classappend="${pattern.dateCodeMap[date.toString()] != null ? 'code-' + pattern.dateCodeMap[date.toString()] : ''}"
                                th:data-date="${date.toString()}"
                                th:text="${pattern.dateCodeMap[date.toString()]}">ì½”ë“œ</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </form>

            <!-- ê·¼íƒœì½”ë“œ íŒ¨ë„ -->
            <div class="code-panel">
                <h3>ğŸ“‹ ê·¼íƒœì½”ë“œ ëª©ë¡</h3>
                <table class="code-table">
                    <thead>
                    <tr>
                        <th>ì½”ë“œ</th>
                        <th>ê·¼íƒœëª…</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="shift : ${shiftTypes}">
                        <td th:text="${shift.shiftCode}">00</td>
                        <td th:text="${shift.shiftName}">ì •ìƒê·¼ë¬´</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- íŒ¨í„´ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal-overlay" id="patternModal">
    <div class="modal-content">
        <div class="modal-header">
            ìƒˆ íŒ¨í„´ ì¶”ê°€
        </div>
        <div class="modal-body">
            <div class="modal-input-group">
                <label for="modalPatternName">íŒ¨í„´ëª… *</label>
                <input type="text" id="modalPatternName" placeholder="ì˜ˆ: ì£¼ê°„, 4ì „, ìœ¡ì•„íœ´ì§..." required>
            </div>
            <div class="modal-input-group">
                <label for="modalPatternDesc">íŒ¨í„´ ì„¤ëª…</label>
                <input type="text" id="modalPatternDesc" placeholder="íŒ¨í„´ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-btn modal-btn-cancel" id="modalCancelBtn">ì·¨ì†Œ</button>
            <button type="button" class="modal-btn modal-btn-confirm" id="modalConfirmBtn">ì¶”ê°€</button>
        </div>
    </div>
</div>

<!-- íŒ¨í„´ ìƒì„±ìš© ìˆ¨ì€ form -->
<form id="createPatternForm" method="post" th:action="@{/pattern/create}">
    <input type="hidden" name="patternName" id="patternNameInput">
    <input type="hidden" name="description" id="patternDescInput">
</form>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const topBtn = document.getElementById("topActionBtn");
        const registerBtn = document.getElementById("registerPatternBtn");
        const saveBtn = document.getElementById("savePatternBtn");
        const tbody = document.getElementById("patternBody");
        const modal = document.getElementById("patternModal");
        const modalCancelBtn = document.getElementById("modalCancelBtn");
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");
        const modalPatternName = document.getElementById("modalPatternName");
        const modalPatternDesc = document.getElementById("modalPatternDesc");
        let rowAdded = false;
        let editingRow = null;

        // ê·¼íƒœì½”ë“œ íŒ¨ë„ ìƒ‰ìƒ ì ìš©
        document.querySelectorAll('.code-table tbody tr').forEach(row => {
            const codeCell = row.cells[0];
            if (codeCell) codeCell.classList.add(`code-${codeCell.textContent.trim()}`);
        });

        // ëª¨ë‹¬ ì—´ê¸°
        topBtn.addEventListener("click", () => {
            if (!rowAdded) {
                modal.classList.add("active");
                modalPatternName.focus();
            }
        });

        // ëª¨ë‹¬ ë‹«ê¸° (ì·¨ì†Œ ë²„íŠ¼)
        modalCancelBtn.addEventListener("click", () => {
            modal.classList.remove("active");
            modalPatternName.value = "";
            modalPatternDesc.value = "";
        });

        // ëª¨ë‹¬ ë‹«ê¸° (ë°°ê²½ í´ë¦­)
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("active");
                modalPatternName.value = "";
                modalPatternDesc.value = "";
            }
        });

        // ëª¨ë‹¬ í™•ì¸ ë²„íŠ¼
        modalConfirmBtn.addEventListener("click", () => {
            const patternName = modalPatternName.value.trim();

            if (!patternName) {
                alert("íŒ¨í„´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                modalPatternName.focus();
                return;
            }

            document.getElementById("patternNameInput").value = patternName;
            document.getElementById("patternDescInput").value = modalPatternDesc.value.trim();

            document.getElementById("createPatternForm").submit();
            rowAdded = true;
        });

        // Enter í‚¤ë¡œ í™•ì¸
        modalPatternDesc.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                modalConfirmBtn.click();
            }
        });

        // íŒ¨í„´ ë“±ë¡ ë²„íŠ¼ í´ë¦­
        registerBtn.addEventListener("click", () => {
            const selectedRadio = document.querySelector('input[name="selectedPattern"]:checked');

            if (!selectedRadio) {
                alert("íŒ¨í„´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const patternName = selectedRadio.value;
            const row = selectedRadio.closest('tr');

            // ì´ë¯¸ í¸ì§‘ ì¤‘ì¸ í–‰ì´ ìˆìœ¼ë©´ ë˜ëŒë¦¬ê¸°
            if (editingRow && editingRow !== row) {
                restoreRow(editingRow);
            }

            editingRow = row;

            // íŒ¨í„´ëª… ì €ì¥
            document.getElementById("savePatternName").value = patternName;

            // ì½”ë“œ ì…€ë“¤ì„ inputìœ¼ë¡œ ë³€ê²½
            const codeCells = row.querySelectorAll('.code-cell');
            codeCells.forEach(cell => {
                const currentValue = cell.textContent.trim();
                const date = cell.getAttribute('data-date');

                // ê¸°ì¡´ ìƒ‰ìƒ í´ë˜ìŠ¤ ì œê±°
                cell.className = 'code-cell editable-cell';

                cell.innerHTML = `<input type="text"
                                         autocomplete="off"
                                         name="dateCodeMap[${date}]"
                                         value="${currentValue}"
                                         data-date="${date}">`;
            });

            // ì €ì¥ ë²„íŠ¼ í‘œì‹œ
            saveBtn.style.display = "block";
            registerBtn.style.display = "none";
        });

        // ì €ì¥ ë²„íŠ¼ í´ë¦­
        saveBtn.addEventListener("click", () => {
            if (!editingRow) return;

            const patternName = document.getElementById("savePatternName").value;

            if (!patternName) {
                alert("íŒ¨í„´ëª…ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
            }

            // í¼ ì œì¶œ
            document.getElementById("patternSaveForm").submit();
        });

        // í–‰ ë³µì› í•¨ìˆ˜
        function restoreRow(row) {
            const codeCells = row.querySelectorAll('.code-cell');
            codeCells.forEach(cell => {
                if (cell.classList.contains('editable-cell')) {
                    const input = cell.querySelector('input');
                    const value = input ? input.value.trim() : '';
                    cell.classList.remove('editable-cell');

                    // ìƒ‰ìƒ í´ë˜ìŠ¤ ë‹¤ì‹œ ì ìš©
                    if (value) {
                        cell.classList.add(`code-${value}`);
                    }
                    cell.innerHTML = value;
                }
            });
        }
    });
</script>
<script th:src="@{/js/script.js}"></script>
</body>
</html>