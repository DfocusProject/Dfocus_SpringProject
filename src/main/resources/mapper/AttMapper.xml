<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.skuniv.dfocus_project.mapper.AttMapper">
    <!-- 실제 출퇴근 기록 시간 -->
    <select id="getActualCommuteRecord" resultType="com.skuniv.dfocus_project.dto.TimeRecordDto" parameterType="map">
        SELECT
            start_time as startTime,
            end_time as endTime
        FROM WEBCOMMUTERECORD
        WHERE emp_code = #{empCode}
          AND work_date = #{selectedDate}
    </select>

    <!-- 계획된 근태 코드 -->
    <select id="getPlannedShift" resultType="string" parameterType="map">
        SELECT
            s.shift_code
        FROM WEBEMPPLAN p
                 JOIN WEBSHIFTTYPE s
                      ON p.shift_code = s.shift_code
        WHERE p.emp_code = #{empCode}
          AND p.work_date = #{selectedDate}
    </select>

    <!-- 출근 기록 추가 -->
    <insert id="addRecordOnCommute" parameterType="map">
        INSERT INTO WEBCOMMUTERECORD (emp_code, work_date, start_time)
        VALUES (#{empCode}, #{today}, #{now})
    </insert>

    <!-- 퇴근 기록 업데이트 -->
    <update id="addRecordOffCommute" parameterType="map">
        UPDATE WEBCOMMUTERECORD
        SET end_time = #{now}
        WHERE emp_code = #{empCode}
          AND work_date = #{today}
          AND start_time IS NOT NULL
    </update>
    <!-- 출퇴근 계획 시간 -->
    <!-- 근무유형(shift_type) 기준으로 근무시간 조회 -->
    <select id="getPlannedCommuteTime"
            parameterType="string"
            resultType="map">
        SELECT
            CASE
                WHEN over2_start_time IS NOT NULL
                    THEN STUFF(over2_start_time, 3, 0, ':')
                ELSE STUFF(work_on_time, 3, 0, ':')
                END AS start_time,
            CASE
                WHEN over_end_time IS NOT NULL
                    THEN STUFF(over_end_time, 3, 0, ':')
                ELSE STUFF(work_off_time, 3, 0, ':')
                END AS end_time
        FROM WEBSHIFTTYPE
        WHERE shift_code = #{shiftCode}
    </select>

    <!-- 신청 내역(시간) 가져오기 -->
    <select id="getRequestHours" resultType="map" parameterType="map">
        SELECT TOP 1
            g.start_time,
            g.end_time
        FROM WEBATTREQUEST r
                 JOIN WEBATTREQUESTGENERAL g
                      ON r.request_id = g.request_id
        WHERE r.emp_code = #{empCode}
          AND r.request_date = #{date}
          AND r.attendance_type = #{type}
          AND r.req_status IN ('approval', 'pending')
    </select>
    <select id="getShiftName" resultType="string" parameterType="string">
        SELECT shift_name
        FROM WEBSHIFTTYPE
        WHERE shift_code = #{shiftCode}
    </select>

    <select id="existsAttendanceRequest" resultType="int">
        SELECT COUNT(*)
        FROM WEBATTREQUEST
        WHERE emp_code = #{empCode}
        AND request_date = #{selectedDate}
        AND attendance_type = #{attType}
        AND req_status = 'REQUESTED'
    </select>
    <!-- 승인 상태 여부 -->
    <select id="isApproved" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM WEBATTREQUEST
        WHERE emp_code = #{empCode}
          AND request_date = #{workDate}
          AND attendance_type = #{conflictType}
          AND req_status = 'APPROVED'
    </select>


    <insert id="insertAttendanceRequest"
            parameterType="com.skuniv.dfocus_project.dto.BaseAttEmpDto"
            useGeneratedKeys="true" keyProperty="dto.requestId">

        INSERT INTO WEBATTREQUEST (
            emp_code,
            req_reason,
            request_date,
            req_status,
            req_reason_detail,
            attendance_type,
            applicant
            )
        VALUES (
            #{dto.empCode},
            #{dto.reason},
            #{selectedDate},
            #{dto.status},
            #{dto.reasonDetail},
            #{dto.attType},
            #{applicant}
        )
    </insert>

    <update id="updateAttendanceRequest" parameterType="com.skuniv.dfocus_project.dto.BaseAttEmpDto">
        UPDATE WEBATTREQUEST
        SET
            req_reason = #{dto.reason},
            req_reason_detail = #{dto.reasonDetail},
            applicant = #{applicant}
        WHERE request_id = #{dto.requestId}
    </update>

    <select id="findAttendanceRecord" resultType="com.skuniv.dfocus_project.dto.AttEmpViewDto">
        SELECT
            req_reason AS reason,
            req_reason_detail AS reasonDetail,
            req_status AS status,
            applicant
        FROM WEBATTREQUEST
        WHERE emp_code = #{empCode}
          AND request_date = #{selectedDate}
          AND attendance_type = #{attType}
    </select>
    <delete id="deleteAttendanceRecord" parameterType="map">
        DELETE FROM WEBATTREQUEST
        WHERE request_id = #{requestId}
    </delete>
    <select id="findAttendanceRequestId" parameterType="map" resultType="long">
        SELECT TOP 1 request_id
        FROM WEBATTREQUEST
        WHERE emp_code = #{empNo}
          AND attendance_type = #{workType}
          AND request_date = #{workDate}
    </select>

    <!-- 결재선 레코드 삽입 -->
    <insert id="insertApprovalRecord" parameterType="map">
        INSERT INTO WEBAPPROVALLINE
        (emp_request, emp_response, request_id, sequence_no, approval_status, approval_time)
        VALUES
            (#{emp_request}, #{emp_response}, #{requestId}, #{sequenceNo}, #{status}, #{approval_time})
    </insert>
    <update id="updateAttendanceStatus">
        UPDATE WEBATTREQUEST
        SET req_status = #{status}
        WHERE request_id = #{requestId}
    </update>

    <select id="existRequestRecord" parameterType="long" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM WEBAPPROVALLINE
        WHERE request_id = #{requestId}
    </select>

    <insert id="insertAttendanceRequestGeneral" parameterType="com.skuniv.dfocus_project.dto.BaseAttEmpDto">
        INSERT INTO WEBATTREQUESTGENERAL (
        request_id,
        start_time,
        end_time,
        half_type,
        start_next_day,
        end_next_day
        )
        VALUES (
        #{requestId},
        #{startTime, jdbcType=TIME},
        #{endTime, jdbcType=TIME},
        #{halfType},
        <choose>
            <when test="startNextDay == true">1</when>
            <otherwise>0</otherwise>
        </choose>,
        <choose>
            <when test="endNextDay == true">1</when>
            <otherwise>0</otherwise>
        </choose>
        )
    </insert>


    <update id="updateAttendanceRequestGeneral" parameterType="com.skuniv.dfocus_project.dto.BaseAttEmpDto">
        UPDATE WEBATTREQUESTGENERAL
        SET
            start_time = #{startTime, jdbcType=TIME},
            end_time = #{endTime, jdbcType=TIME},
            start_next_day = #{startNextDay, jdbcType=INTEGER},
            end_next_day = #{endNextDay, jdbcType=INTEGER},
            half_type = #{halfType, jdbcType=VARCHAR}  <!-- 여기 추가 -->
        WHERE request_id = #{requestId}
    </update>


    <!-- TimeRange ResultMap -->
    <resultMap id="timeRangeMap" type="com.skuniv.dfocus_project.domain.Time.TimeRange">
        <constructor>
            <arg column="baseDate" javaType="java.time.LocalDate"/>
            <arg column="startTime" javaType="java.time.LocalTime"/>
            <arg column="startNextDay" javaType="boolean"/>
            <arg column="endTime" javaType="java.time.LocalTime"/>
            <arg column="endNextDay" javaType="boolean"/>
        </constructor>
    </resultMap>

    <!-- 계획 출퇴근 시간 조회 - HHMM 형식 -->
    <select id="getPlannedCommuteTime2" resultMap="timeRangeMap">
        SELECT
            es.work_date AS baseDate,
            CAST(STUFF(s.work_on_time, 3, 0, ':') AS TIME) AS startTime,
            CAST(0 AS BIT) AS startNextDay,
            CAST(STUFF(s.work_off_time, 3, 0, ':') AS TIME) AS endTime,
            CAST(s.work_off_next_day AS BIT) AS endNextDay
        FROM WEBSHIFTTYPE s
                 JOIN WEBEMPPLAN es ON s.shift_code = es.shift_code
        WHERE es.emp_code = #{empCode}
          AND es.work_date = #{workDate}
    </select>

    <!-- 실제 출퇴근 시간 조회 - TIME 타입 -->
    <select id="getRealCommuteTime2" resultMap="timeRangeMap">
        SELECT
            a.work_date AS baseDate,
            a.start_time AS startTime,
            CAST(0 AS BIT) AS startNextDay,
            a.end_time AS endTime,
            CAST(a.end_next_day AS BIT) AS endNextDay
        FROM WEBCOMMUTERECORD a
        WHERE a.emp_code = #{empCode}
          AND a.work_date = #{workDate}
          AND a.start_time IS NOT NULL
          AND a.end_time IS NOT NULL
    </select>

    <!-- 신청 근무 시간 조회 - HH:MM 형식 -->
    <select id="getRequestWorkTime2" resultMap="timeRangeMap">
        SELECT
            r.request_date AS baseDate,
            CAST(rg.start_time AS TIME) AS startTime,
            CAST(rg.start_next_day AS BIT) AS startNextDay,
            CAST(rg.end_time AS TIME) AS endTime,
            CAST(rg.end_next_day AS BIT) AS endNextDay
        FROM WEBATTREQUESTGENERAL rg
                 JOIN WEBATTREQUEST r ON rg.request_id = r.request_id
        WHERE r.request_date = #{workDate}
          AND r.emp_code = #{empCode}
          AND r.attendance_type = #{reqType}
          AND r.req_status IN ('REQUESTED', 'APPROVED')
    </select>


    <!-- 계획 휴게 시간 조회 - HHMM 형식 -->
    <select id="getPlannedRestTime2" resultMap="timeRangeMap">
        SELECT
            es.work_date AS baseDate,
            CAST(STUFF(s.break1_start_time, 3, 0, ':') AS TIME) AS startTime,
            CAST(s.break1_start_next_day AS BIT) AS startNextDay,
            CAST(STUFF(s.break1_end_time, 3, 0, ':') AS TIME) AS endTime,
            CAST(s.break1_end_next_day AS BIT) AS endNextDay
        FROM WEBSHIFTTYPE s
                 JOIN WEBEMPPLAN es ON s.shift_code = es.shift_code
        WHERE es.emp_code = #{empCode}
          AND es.work_date = #{workDate}
          AND s.break1_start_time IS NOT NULL
          AND s.break1_end_time IS NOT NULL
    </select>
    <delete id="deleteApprovalLine" parameterType="long">
        DELETE FROM WEBAPPROVALLINE
        WHERE request_id = #{requestId}
    </delete>

    <select id="getAllRequestWorkTimeForDate" resultType="map">
        SELECT
            r.attendance_type,
            rg.half_type,
            CAST(rg.start_time AS TIME) AS startTime,
            CAST(rg.start_next_day AS BIT) AS startNextDay,
            CAST(rg.end_time AS TIME) AS endTime,
            CAST(rg.end_next_day AS BIT) AS endNextDay
        FROM WEBATTREQUESTGENERAL rg
                 JOIN WEBATTREQUEST r ON rg.request_id = r.request_id
        WHERE r.request_date = #{workDate}
          AND r.emp_code = #{empCode}
          AND r.attendance_type IN ('휴일', '연장', '조출', '반차', '조퇴')
          AND r.req_status IN ('REQUESTED', 'APPROVED')
    </select>

    <select id="getAllowedTimeRange" resultMap="timeRangeMap" parameterType="map">
        SELECT
            es.work_date AS baseDate,
            CAST(
                    CASE
                        WHEN #{attType} = '연장' THEN STUFF(s.over_start_time, 3, 0, ':')
                        WHEN #{attType} = '조출' THEN STUFF(s.over2_start_time, 3, 0, ':')
                        END AS TIME
            ) AS startTime,
            CAST(
                    CASE
                        WHEN #{attType} = '연장' THEN s.over_start_next_day
                        WHEN #{attType} = '조출' THEN s.over2_start_next_day
                        ELSE 0
                        END AS BIT
            ) AS startNextDay,
            CAST(
                    CASE
                        WHEN #{attType} = '연장' THEN STUFF(s.over_end_time, 3, 0, ':')
                        WHEN #{attType} = '조출' THEN STUFF(s.over2_end_time, 3, 0, ':')
                        END AS TIME
            ) AS endTime,
            CAST(
                    CASE
                        WHEN #{attType} = '연장' THEN s.over_end_next_day
                        WHEN #{attType} = '조출' THEN s.over2_end_next_day
                        ELSE 0
                        END AS BIT
            ) AS endNextDay
        FROM WEBSHIFTTYPE s
                 JOIN WEBEMPPLAN es ON s.shift_code = es.shift_code
        WHERE es.emp_code = #{empCode}
          AND es.work_date = #{workDate}
    </select>
    <insert id="insertEtcAttendance">
        INSERT INTO WEBATTREQUESTSPECIAL (
            request_id,
            origin_shift_code,
            new_shift_code,
            start_date,
            end_date,
            is_today_request
        )
        VALUES (
                   #{requestId},
                   #{planType},
                   #{newShiftType},
                   #{startDate},
                   #{endDate},
                   #{isTodayRequest}
               )
    </insert>
    <update id="updateEtcAttendance">
        UPDATE WEBATTREQUESTSPECIAL
        SET
            origin_shift_code = #{planType},
            new_shift_code = #{newShiftType},       -- 변경될 근무코드
            start_date = #{startDate},
            end_date = #{endDate},
            is_today_request = #{isTodayRequest}
        WHERE request_id = #{requestId}
    </update>
    <select id="getAttendanceRequestsByDate" resultType="com.skuniv.dfocus_project.dto.BaseAttEmpDto">
        SELECT
        r.request_id AS requestId,
        r.emp_code AS empCode,
        r.attendance_type AS attType,
        g.start_time AS startTime,
        g.start_next_day AS startNextDay,
        g.end_time AS endTime,
        g.end_next_day AS endNextDay
        FROM webattrequest r
        INNER JOIN webattrequestgeneral g ON r.request_id = g.request_id
        WHERE r.emp_code = #{empCode}
        AND r.request_date = #{workDate}
        AND r.attendance_type IN
        <foreach collection="types" item="type" open="(" separator="," close=")">
            #{type}
        </foreach>
        AND r.req_status IN ('requested', 'approved')
    </select>
    <select id="existsHalfDayRequest" resultType="int">
        SELECT COUNT(*)
        FROM WEBATTREQUEST r
                 INNER JOIN WEBATTREQUESTGENERAL g
                            ON r.request_id = g.request_id
        WHERE r.emp_code = #{empCode}
          AND r.request_date = #{workDate, jdbcType=DATE}
          AND r.attendance_type = '반차'
          AND g.half_type = #{halfType}
          AND r.req_status IN ('REQUESTED','APPROVED')
    </select>


    <select id="isHoliday" resultType="boolean" parameterType="map">
        SELECT CASE WHEN COUNT(1) > 0 THEN 1 ELSE 0 END
        FROM WEBEMPPLAN P
                 INNER JOIN WEBEMPINFO I ON P.EMP_CODE = I.EMP_CODE
        WHERE P.EMP_CODE = #{empCode}
          AND P.WORK_DATE = #{workDate}
          AND P.HOLIDAY_YN = 'Y'
    </select>
    <select id="hasHolidayWorkOver8Hours" resultType="boolean" parameterType="map">
        SELECT CASE
                   WHEN ISNULL(SUM(DATEDIFF(HOUR,
                           CASE
                               WHEN G.START_NEXT_DAY = 1
                                   THEN DATEADD(SECOND, DATEDIFF(SECOND, '00:00:00', G.START_TIME), DATEADD(DAY,1,R.REQUEST_DATE))
                               ELSE DATEADD(SECOND, DATEDIFF(SECOND, '00:00:00', G.START_TIME), CAST(R.REQUEST_DATE AS DATETIME))
                               END,
                           CASE
                               WHEN G.END_NEXT_DAY = 1
                                   THEN DATEADD(SECOND, DATEDIFF(SECOND, '00:00:00', G.END_TIME), DATEADD(DAY,1,R.REQUEST_DATE))
                               ELSE DATEADD(SECOND, DATEDIFF(SECOND, '00:00:00', G.END_TIME), CAST(R.REQUEST_DATE AS DATETIME))
                               END
                                   )),0) >= 8 THEN 1 ELSE 0
                   END AS hasOver8Hours
        FROM WEBATTREQUEST R
                 INNER JOIN WEBATTREQUESTGENERAL G ON R.REQUEST_ID = G.REQUEST_ID
        WHERE R.EMP_CODE = #{empCode}
          AND R.ATTENDANCE_TYPE = '휴일'
          AND R.REQUEST_DATE = #{workDate}
          AND R.REQ_STATUS IN ('SAVED','REQUESTED', 'APPROVED')
    </select>
    <select id="alreadyRequested" resultType="boolean" parameterType="long">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM WEBATTREQUEST
        WHERE request_id = #{requestId}
          AND req_status = 'REQUESTED'
    </select>

    <update id="updateShiftPlan">
        UPDATE WEBEMPPLAN
        SET
            shift_code = #{dto.newShiftType},
            origin_shift_code = #{dto.planType}
        WHERE
            emp_code = #{dto.empCode}
          AND work_date = #{selectedDate}
    </update>
    <select id="existsAttendance" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM WEBATTREQUEST
        WHERE EMP_CODE = #{empCode}
          AND REQUEST_DATE = #{selectedDate}
          AND ATTENDANCE_TYPE = #{attType}
          AND REQ_STATUS IN ('APPROVED', 'REQUESTED')
    </select>
    <select id="findExistingEtcRequests" resultType="com.skuniv.dfocus_project.dto.ExistingEtcRequestDto">
        SELECT
        RS.START_DATE AS startDate,
        RS.END_DATE AS endDate,
        R.ATTENDANCE_TYPE AS etcType
        FROM WEBATTREQUEST R
        JOIN WEBATTREQUESTSPECIAL RS
        ON RS.REQUEST_ID = R.REQUEST_ID
        WHERE R.EMP_CODE = #{empCode}
        AND R.ATTENDANCE_TYPE IN ('기타', '연차')
        AND R.REQ_STATUS IN ('REQUESTED', 'APPROVED')
        AND CONVERT(DATE, RS.START_DATE) &lt;= CONVERT(DATE, #{end})
        AND CONVERT(DATE, RS.END_DATE) &gt;= CONVERT(DATE, #{start})
    </select>

</mapper>
