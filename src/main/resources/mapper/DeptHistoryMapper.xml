<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.skuniv.dfocus_project.mapper.DeptHistoryMapper">
    <select id="findChildDepts" parameterType="string" resultType="string">
        WITH child_cte AS (
            -- 시작점: 자기 부서 포함
            SELECT dept_code, parent_dept
            FROM webdeptinfo
            WHERE dept_code = #{deptCode}

            UNION ALL

            -- 자식 부서로 재귀
            SELECT w.dept_code, w.parent_dept
            FROM webdeptinfo w
                     INNER JOIN child_cte c ON w.parent_dept = c.dept_code
        )
        SELECT dept_code
        FROM child_cte
    </select>


    <select id="findEmpsBySearch" parameterType="com.skuniv.dfocus_project.dto.att.DeptAttSearchDto" resultType="com.skuniv.dfocus_project.dto.att.DeptAttSearchResultDto">
        SELECT
        i.emp_code AS empCode,
        i.emp_name AS empName,
        wp.position_name AS position,
        c.start_time AS workOnTime,
        c.end_time AS workOffTime,
        d.dept_name AS department,
        ws.shift_name AS planType
        FROM WEBEMPINFO i
        LEFT JOIN WEBEMPPLAN p
        ON p.emp_code = i.emp_code
        AND p.work_date = #{workDate}
        LEFT JOIN WEBCOMMUTERECORD c
        ON c.emp_code = p.emp_code
        AND c.work_date = p.work_date
        LEFT JOIN WEBPOSITIONINFO wp
        ON i.position_code = wp.position_code
        LEFT JOIN WEBDEPTINFO d
        ON i.dept_code = d.dept_code
        LEFT JOIN WEBSHIFTTYPE ws
        ON p.shift_code = ws.shift_code
        WHERE i.dept_code = #{department}   <!-- ← 이 부분을 JOIN 밖으로 이동 -->

        <!-- 사번(empCode) 조건 -->
        <if test="empCode != null and empCode != ''">
            AND p.emp_code = #{empCode}
        </if>

        <!-- 근무계획(planType) 조건 -->
        <if test="planType != null and planType != ''">
            AND p.shift_code = #{planType}
        </if>
    </select>

</mapper>