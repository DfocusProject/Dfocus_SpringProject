<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.skuniv.dfocus_project.mapper.DeptHistoryMapper">
    <select id="findChildDepts" parameterType="string" resultType="string">
        WITH child_cte AS (
            -- 시작점: 자기 부서 포함
            SELECT dept_code, parent_dept
            FROM webdeptinfo
            WHERE dept_code = #{deptCode}

            UNION ALL

            -- 자식 부서로 재귀
            SELECT w.dept_code, w.parent_dept
            FROM webdeptinfo w
                     INNER JOIN child_cte c ON w.parent_dept = c.dept_code
        )
        SELECT dept_code
        FROM child_cte
    </select>


    <select id="findEmpsBySearch" parameterType="com.skuniv.dfocus_project.dto.att.DeptAttSearchDto" resultType="map">
        SELECT
        i.emp_code AS empCode,
        i.emp_name AS empName,
        i.position_code AS position,
        c.start_time AS workOnTime,
        c.end_time AS workOffTime
        FROM WEBEMPPLAN p
        JOIN WEBEMPINFO i ON p.emp_code = i.emp_code
        LEFT JOIN WEBCOMMUTERECORD c
        ON c.emp_code = p.emp_code
        AND c.work_date = p.work_date
        WHERE p.work_date = #{workDate}
        AND i.dept_code = #{deptCode}

        <!-- 사번(empCode) 조건 -->
        <if test="empCode != null and empCode != ''">
            AND p.emp_code = #{empCode}
        </if>

        <!-- 근무계획(shiftCode) 조건 -->
        <if test="shiftCode != null and shiftCode != ''">
            AND p.shift_code = #{shiftCode}
        </if>
    </select>
</mapper>